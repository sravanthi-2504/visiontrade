<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Stocks Dashboard | 3500+ Stocks with Sector Classification</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #8b5cf6;
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        .sector-chip, .market-cap-chip {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .sector-chip.active, .market-cap-chip.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .stock-row:hover {
            background-color: rgba(59, 130, 246, 0.08);
            transform: translateY(-1px);
        }

        .positive-change {
            color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: 4px;
            padding: 2px 8px;
            font-weight: 600;
        }

        .negative-change {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
            padding: 2px 8px;
            font-weight: 600;
        }

        .risk-low {
            color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
            border-radius: 9999px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .risk-medium {
            color: #f59e0b;
            background-color: rgba(245, 158, 11, 0.1);
            border-radius: 9999px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .risk-high {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 9999px;
            padding: 2px 10px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .recommendation-strong-buy {
            color: #10b981;
            font-weight: 700;
            background: rgba(16, 185, 129, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .recommendation-buy {
            color: #22c55e;
            font-weight: 700;
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .recommendation-hold {
            color: #f59e0b;
            font-weight: 700;
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .recommendation-sell {
            color: #ef4444;
            font-weight: 700;
            background: rgba(239, 68, 68, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .recommendation-strong-sell {
            color: #dc2626;
            font-weight: 700;
            background: rgba(220, 38, 38, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .dark-table {
            background-color: #1e293b;
        }

        .dark-table th {
            background-color: #1e293b;
            border-color: #334155;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dark-table td {
            border-color: #334155;
        }

        .pagination-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Live price animation */
        .price-update {
            animation: priceUpdate 0.5s ease-out;
        }

        @keyframes priceUpdate {
            0% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: transparent; }
        }

        /* Market cap colors */
        .large-cap {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }
        .mid-cap {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }
        .small-cap {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }
        .micro-cap {
            color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Sector colors - Static classes for Tailwind */
        .sector-banking { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .sector-finance { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
        .sector-it { background: rgba(139, 92, 246, 0.2); border-color: #8b5cf6; }
        .sector-automobile { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .sector-pharma { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; }
        .sector-fmcg { background: rgba(245, 158, 11, 0.2); border-color: #f59e0b; }
        .sector-energy { background: rgba(20, 184, 166, 0.2); border-color: #14b8a6; }
        .sector-metals { background: rgba(249, 115, 22, 0.2); border-color: #f97316; }
        .sector-infrastructure { background: rgba(168, 85, 247, 0.2); border-color: #a855f7; }
        .sector-telecom { background: rgba(236, 72, 153, 0.2); border-color: #ec4899; }
        .sector-real-estate { background: rgba(244, 63, 94, 0.2); border-color: #f43f5e; }
        .sector-healthcare { background: rgba(6, 182, 212, 0.2); border-color: #06b6d4; }
        .sector-chemicals { background: rgba(139, 92, 246, 0.2); border-color: #8b5cf6; }
        .sector-consumer-goods { background: rgba(217, 70, 239, 0.2); border-color: #d946ef; }
        .sector-oil-gas { background: rgba(6, 182, 212, 0.2); border-color: #06b6d4; }
        .sector-cement { background: rgba(148, 163, 184, 0.2); border-color: #94a3b8; }
        .sector-textiles { background: rgba(251, 191, 36, 0.2); border-color: #fbbf24; }
        .sector-media { background: rgba(244, 114, 182, 0.2); border-color: #f472b6; }
        .sector-agriculture { background: rgba(101, 163, 13, 0.2); border-color: #65a30d; }
        .sector-aviation { background: rgba(2, 132, 199, 0.2); border-color: #0284c7; }
        .sector-retail { background: rgba(192, 38, 211, 0.2); border-color: #c026d3; }
        .sector-insurance { background: rgba(5, 150, 105, 0.2); border-color: #059669; }
        .sector-logistics { background: rgba(124, 58, 237, 0.2); border-color: #7c3aed; }
        .sector-power { background: rgba(234, 88, 12, 0.2); border-color: #ea580c; }
        .sector-defence { background: rgba(220, 38, 38, 0.2); border-color: #dc2626; }
        .sector-railway { background: rgba(2, 132, 199, 0.2); border-color: #0284c7; }
        .sector-psu { background: rgba(30, 64, 175, 0.2); border-color: #1e40af; }
        .sector-other { background: rgba(100, 116, 139, 0.2); border-color: #64748b; }
    </style>
</head>
<body class="min-h-screen bg-gray-900 text-gray-200">
<!-- Navigation -->
<nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <i class="fas fa-chart-line text-blue-400 text-2xl"></i>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Indian Stocks Dashboard</h1>
                    <p class="text-sm text-gray-400">3500+ Stocks with Sector Classification</p>
                </div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="hidden md:flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <span class="text-green-400 font-semibold" id="connectionStatus">LIVE</span>
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="liveStocksCount">0</span> stocks live
                    </div>
                </div>
                <a href="index.html" class="text-gray-300 hover:text-white flex items-center px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Main Dashboard -->
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h2 class="text-3xl font-bold text-white mb-2">Complete Indian Stocks Universe</h2>
                <p class="text-gray-400">3500+ stocks across 25+ sectors with real-time classification</p>
            </div>
            <div class="bg-gray-800 rounded-xl p-4 border border-gray-700">
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Last Update</div>
                        <div id="lastUpdated" class="text-lg font-semibold text-green-400 blink">
                            <i class="fas fa-sync-alt mr-2"></i>Loading...
                        </div>
                    </div>
                    <div class="h-8 w-px bg-gray-700"></div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Market</div>
                        <div id="marketStatus" class="text-lg font-bold">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Summary -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-5 border border-gray-700 hover:border-blue-500 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-gray-400 text-sm mb-1">NIFTY 50</div>
                    <div id="niftyValue" class="text-2xl font-bold text-white">--</div>
                    <div id="niftyChange" class="text-sm mt-1">--</div>
                </div>
                <div class="text-blue-400">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
            </div>
            <div class="text-xs text-gray-500 mt-3" id="niftyStatus">Connecting to NSE...</div>
        </div>

        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-5 border border-gray-700 hover:border-green-500 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-gray-400 text-sm mb-1">SENSEX</div>
                    <div id="sensexValue" class="text-2xl font-bold text-white">--</div>
                    <div id="sensexChange" class="text-sm mt-1">--</div>
                </div>
                <div class="text-green-400">
                    <i class="fas fa-chart-bar text-xl"></i>
                </div>
            </div>
            <div class="text-xs text-gray-500 mt-3" id="sensexStatus">Connecting to BSE...</div>
        </div>

        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-5 border border-gray-700 hover:border-purple-500 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-gray-400 text-sm mb-1">Total Stocks</div>
                    <div id="totalStocks" class="text-2xl font-bold text-white">3,500+</div>
                    <div class="text-sm text-gray-400 mt-1">25+ Sectors</div>
                </div>
                <div class="text-purple-400">
                    <i class="fas fa-layer-group text-xl"></i>
                </div>
            </div>
            <div class="text-xs text-gray-500 mt-3" id="sectorCount">Loading sectors...</div>
        </div>

        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl p-5 border border-gray-700 hover:border-yellow-500 transition-colors">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-gray-400 text-sm mb-1">Sectors</div>
                    <div id="sectorsCount" class="text-2xl font-bold text-white">25+</div>
                    <div class="text-sm text-gray-400 mt-1">Properly classified</div>
                </div>
                <div class="text-yellow-400">
                    <i class="fas fa-tags text-xl"></i>
                </div>
            </div>
            <div class="text-xs text-gray-500 mt-3">AI-powered classification</div>
        </div>
    </div>

    <!-- Market Cap Distribution -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-white">Market Capitalization</h3>
            <div class="text-sm text-gray-400" id="capDistribution">Loading...</div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="market-cap-chip p-4 rounded-xl border border-blue-600 bg-blue-900/20 active"
                 onclick="filterByMarketCap('all')" id="marketCapAll">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-blue-400 font-semibold">ALL STOCKS</div>
                        <div class="text-2xl font-bold text-white mt-1" id="capCountAll">3,500+</div>
                    </div>
                    <i class="fas fa-layer-group text-blue-400 text-xl"></i>
                </div>
            </div>

            <div class="market-cap-chip p-4 rounded-xl border border-blue-600/30 text-blue-400 hover:border-blue-600 hover:bg-blue-900/20"
                 onclick="filterByMarketCap('large')" id="marketCapLarge">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">LARGE CAP</div>
                        <div class="text-2xl font-bold text-white mt-1" id="capCountLarge">100+</div>
                    </div>
                    <i class="fas fa-building text-blue-400/70 text-xl"></i>
                </div>
            </div>

            <div class="market-cap-chip p-4 rounded-xl border border-green-600/30 text-green-400 hover:border-green-600 hover:bg-green-900/20"
                 onclick="filterByMarketCap('mid')" id="marketCapMid">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">MID CAP</div>
                        <div class="text-2xl font-bold text-white mt-1" id="capCountMid">150+</div>
                    </div>
                    <i class="fas fa-chart-line text-green-400/70 text-xl"></i>
                </div>
            </div>

            <div class="market-cap-chip p-4 rounded-xl border border-yellow-600/30 text-yellow-400 hover:border-yellow-600 hover:bg-yellow-900/20"
                 onclick="filterByMarketCap('small')" id="marketCapSmall">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-semibold">SMALL CAP</div>
                        <div class="text-2xl font-bold text-white mt-1" id="capCountSmall">3,000+</div>
                    </div>
                    <i class="fas fa-chart-bar text-yellow-400/70 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="mb-6">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Search Bar -->
            <div class="flex-1">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                    <input type="text" id="searchStocks"
                           class="w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Search stocks (symbol, company, sector)...">
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">
                        <span id="searchResultsCount">0</span> results
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="flex gap-2">
                <select id="sortBy" class="bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 min-w-[180px]">
                    <option value="market_cap_desc">Market Cap ▼</option>
                    <option value="market_cap_asc">Market Cap ▲</option>
                    <option value="change_desc">Change % ▼</option>
                    <option value="change_asc">Change % ▲</option>
                    <option value="price_desc">Price ▼</option>
                    <option value="price_asc">Price ▲</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                </select>

                <select id="riskFilter" class="bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 min-w-[140px]">
                    <option value="all">All Risk</option>
                    <option value="low">Low Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="high">High Risk</option>
                </select>

                <select id="performanceFilter" class="bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 min-w-[150px]">
                    <option value="all">All Performance</option>
                    <option value="gainers">Top Gainers</option>
                    <option value="losers">Top Losers</option>
                    <option value="active">Most Active</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Sectors Filter -->
    <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-semibold text-white">Sector Classification</h3>
            <button id="toggleSectors" class="text-sm text-blue-400 hover:text-blue-300">
                <i class="fas fa-chevron-down mr-1"></i> Show All Sectors
            </button>
        </div>
        <div id="sectorsContainer" class="flex flex-wrap gap-2">
            <!-- Sectors will be loaded here dynamically -->
            <div class="sector-chip px-4 py-2 rounded-full border border-blue-600 text-blue-400 bg-blue-900/20 active"
                 onclick="filterBySector('all')">
                All Sectors
            </div>
        </div>
        <div id="moreSectors" class="hidden flex-wrap gap-2 mt-2">
            <!-- Additional sectors will be loaded here -->
        </div>
    </div>

    <!-- Stocks Table Container -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden mb-6">
        <!-- Table Header -->
        <div class="px-6 py-4 border-b border-gray-700 bg-gray-900/50">
            <div class="flex justify-between items-center">
                <div>
                    <span class="font-semibold text-white" id="tableTitle">All Stocks</span>
                    <span class="text-sm text-gray-400 ml-2" id="tableSubtitle">Showing 0 of 0</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-400">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="dataFreshness">Just now</span>
                    </div>
                    <button onclick="refreshAllData()" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Stocks Table -->
        <div class="overflow-x-auto custom-scrollbar" style="max-height: 600px;">
            <table class="w-full dark-table">
                <thead>
                <tr class="bg-gray-900">
                    <th class="py-4 px-6 text-left font-semibold text-gray-300 sticky left-0 bg-gray-900 z-20">
                        <div class="flex items-center">
                            <i class="fas fa-hashtag mr-2"></i>
                            <span>Symbol & Company</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-tag mr-2"></i>
                            <span>Sector</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-layer-group mr-2"></i>
                            <span>Market Cap</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-bullhorn mr-2"></i>
                            <span>Recommendation</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-shield-alt mr-2"></i>
                            <span>Risk Level</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300">
                        <div class="flex items-center">
                            <i class="fas fa-rupee-sign mr-2"></i>
                            <span>Current Price</span>
                        </div>
                    </th>
                    <th class="py-4 px-6 text-left font-semibold text-gray-300 sticky right-0 bg-gray-900 z-20">
                        <div class="flex items-center">
                            <i class="fas fa-bolt mr-2"></i>
                            <span>Actions</span>
                        </div>
                    </th>
                </tr>
                </thead>
                <tbody id="stocksTableBody">
                <!-- Stocks will be loaded here dynamically -->
                </tbody>
            </table>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <div class="inline-block">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <div class="text-gray-400">Loading 3500+ stocks...</div>
                <div class="text-sm text-gray-500 mt-2">Applying sector classification...</div>
                <div class="mt-4 text-sm text-gray-500" id="loadingProgress">Initializing...</div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden p-8 text-center">
            <i class="fas fa-search fa-3x text-gray-600 mb-4"></i>
            <div class="text-gray-400 text-lg mb-2">No stocks found</div>
            <div class="text-gray-500">Try changing your search or filters</div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mb-8">
        <div class="text-gray-400 text-sm" id="paginationInfo">
            Loading stocks data...
        </div>
        <div class="flex items-center space-x-2" id="pagination">
            <button class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 disabled:opacity-50"
                    disabled id="prevPage">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="flex items-center space-x-1" id="pageNumbers"></div>
            <button class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 disabled:opacity-50"
                    disabled id="nextPage">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Data Source Info -->
    <div class="text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
        <div class="flex flex-wrap justify-center items-center gap-4">
            <div class="flex items-center">
                <i class="fas fa-tags mr-2"></i>
                <span>AI-powered sector classification</span>
            </div>
            <div class="w-px h-4 bg-gray-700"></div>
            <div class="flex items-center">
                <i class="fas fa-industry mr-2"></i>
                <span>25+ sectors identified</span>
            </div>
            <div class="w-px h-4 bg-gray-700"></div>
            <div class="flex items-center">
                <i class="fas fa-database mr-2"></i>
                <span>3,500+ Indian companies</span>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // ==================== SECTOR CLASSIFICATION SYSTEM ====================
    const SECTOR_MAPPING = {
        'Banking': ['HDFCBANK', 'ICICIBANK', 'SBIN', 'KOTAKBANK', 'AXISBANK', 'INDUSINDBK',
            'BANDHANBNK', 'IDFCFIRSTB', 'YESBANK', 'FEDERALBNK', 'RBLBANK', 'CUB',
            'SOUTHBANK', 'KARURVYSYA', 'J&KBANK', 'DCBBANK', 'CSBBANK', 'UCOBANK',
            'CENTRALBK', 'INDIANB', 'UNIONBANK', 'BANKBARODA', 'CANBK', 'PNB',
            'BANKINDIA', 'MAHABANK', 'UJJIVANSFB', 'AUBANK', 'EQUITAS'],

        'Finance': ['BAJFINANCE', 'BAJAJFINSV', 'CHOLAFIN', 'MUTHOOTFIN', 'MANAPPURAM',
            'PFC', 'RECLTD', 'HDFCAMC', 'ICICIPRULI', 'SBILIFE', 'HDFCLIFE',
            'ICICIGI', 'SHRIRAMCIT', 'BAJAJHLDNG', 'M&MFIN', 'IIFL', 'LICHSGFIN',
            'SUNDARMFIN', 'MASFIN', 'MOTILALOFS', 'EDELWEISS', 'JMCPROJECT'],

        'IT': ['TCS', 'INFY', 'WIPRO', 'HCLTECH', 'TECHM', 'LTIM', 'MPHASIS', 'LTI',
            'PERSISTENT', 'COFORGE', 'MINDTREE', 'LTTS', 'TATAELXSI', 'CYIENT',
            'ZENSARTECH', 'HEXAWARE', 'NIITTECH', 'SONATSOFTW', 'NEWGEN',
            'AFFLE', 'ROUTE', 'TANLA', 'INTELLECT', 'EASEMYTRIP', 'NAUKRI'],

        'Automobile': ['MARUTI', 'TATAMOTORS', 'M&M', 'BAJAJ-AUTO', 'HEROMOTOCO',
            'EICHERMOT', 'ASHOKLEY', 'TVSMOTOR', 'ESCORTS', 'BALKRISIND',
            'MRF', 'APOLLOTYRE', 'CEATLTD', 'JKTYRE', 'BHARATFORG', 'SONACOMS',
            'MOTHERSUMI', 'SUPRAJIT', 'SAMVARDHANA', 'BOSCHLTD', 'MOTHERSON'],

        'Pharma': ['SUNPHARMA', 'DRREDDY', 'CIPLA', 'LUPIN', 'DIVISLAB', 'AUROPHARMA',
            'BIOCON', 'TORNTPHARM', 'ALKEM', 'GLENMARK', 'CADILAHC', 'IPCALAB',
            'LAURUSLABS', 'GRANULES', 'NATCOPHARM', 'AJANTPHARM', 'SANOFI',
            'PFIZER', 'ABBOTINDIA', 'GLAXO', 'NOVARTIND', 'ASTRAZEN', 'JBCHEPHARM'],

        'FMCG': ['HINDUNILVR', 'ITC', 'NESTLEIND', 'BRITANNIA', 'DABUR', 'GODREJCP',
            'MARICO', 'COLPAL', 'EMAMILTD', 'PGHH', 'PGHL', 'VBL', 'RADICO',
            'UNITEDSPR', 'UBL', 'MCDOWELL-N', 'JUBLFOOD', 'DMART'],

        'Energy': ['RELIANCE', 'ONGC', 'IOC', 'BPCL', 'HINDPETRO', 'GAIL', 'PETRONET',
            'GSPL', 'IGL', 'MGL', 'GUJGASLTD', 'ADANIGAS', 'ATGL', 'AEGISLOG',
            'NTPC', 'POWERGRID', 'TATAPOWER', 'ADANIPOWER', 'JSWENERGY', 'TORNTPOWER',
            'NHPC', 'SJVN', 'NLCINDIA', 'RECLTD', 'PFC'],

        'Metals': ['TATASTEEL', 'JSWSTEEL', 'HINDALCO', 'VEDL', 'JINDALSTEL', 'SAIL',
            'NMDC', 'HINDCOPPER', 'NATIONALUM', 'HINDZINC', 'MOIL', 'APLAPOLLO',
            'RATNAMANI', 'MAITHANALL', 'SHYAMMETL', 'KIRLOSIND', 'MANAKALUCO'],

        'Infrastructure': ['LT', 'ADANIPORTS', 'IRB', 'GMRINFRA', 'PNCINFRA', 'NCC',
            'KEC', 'KALYANKJIL', 'POWERMECH', 'HGINFRA', 'GRINFRA',
            'ADANIGREEN', 'ADANITRANS', 'IRCON', 'RVNL', 'NBCC', 'GAYAPROJ',
            'ASHOKA', 'MBLINFRA', 'MEP'],

        'Telecom': ['BHARTIARTL', 'IDEA', 'MTNL', 'TATACOMM', 'ITI', 'HFCL',
            'TEJASNET', 'STERLITE', 'VODAFONE', 'INDUSTOWER', 'GTLINFRA'],

        'Real Estate': ['DLF', 'GODREJPROP', 'OBEROIRLTY', 'PRESTIGE', 'SUNTEK', 'BRIGADE',
            'MAHLIFE', 'SOBHA', 'PURVA', 'KOLTEPATIL', 'PHOENIXLTD', 'MINDSPACE',
            'LODHA', 'MEGASTAR', 'ARVIND', 'MAHLOG'],

        'Healthcare': ['APOLLOHOSP', 'FORTIS', 'NARAYANA', 'MAXHEALTH', 'HCG', 'KOVAI',
            'SHALBY', 'GLAND', 'ASTERDM', 'METROPOLIS', 'THYROCARE'],

        'Chemicals': ['UPL', 'PIDILITIND', 'SRF', 'TATACHEM', 'AARTIIND', 'DEEPAKNTR',
            'NAVINFLUOR', 'GUJALKALI', 'GNFC', 'FINEORG', 'PIIND', 'VINATIORGA',
            'SOLARINDS', 'ANUP', 'BALAMINES', 'ALKYLAMINE', 'CHEMCON', 'TATVA'],

        'Consumer Goods': ['TITAN', 'ASIANPAINT', 'BERGEPAINT', 'KANSAINER', 'AKZOINDIA',
            'HAVELLS', 'CROMPTON', 'BAJAJELEC', 'VGUARD', 'SYMPHONY', 'WHIRLPOOL',
            'BLUESTARCO', 'VOLTAS', 'TRENT'],

        'Oil & Gas': ['RELIANCE', 'ONGC', 'IOC', 'BPCL', 'HINDPETRO', 'GAIL', 'OIL',
            'PETRONET', 'AEGISLOG', 'GUJGAS', 'MGL', 'IGL', 'ADANIGAS',
            'ATGL', 'GSPL', 'LINDEINDIA', 'CHENNPETRO', 'MRPL'],

        'Cement': ['ULTRACEMCO', 'SHREECEM', 'ACC', 'AMBUJACEM', 'RAMCOCEM', 'DALBHARAT',
            'JKLAKSHMI', 'JKCEMENT', 'HEIDELBERG', 'BIRLACORPN', 'SAGCEM',
            'MANGALMCEM', 'KCP', 'BINANI', 'PRISMJOHNSON', 'NUVOCO'],

        'Textiles': ['ARVIND', 'KPRMILL', 'VARDHACRLC', 'TRIDENT', 'WELSPUNIND', 'ALOKTEXT',
            'BOMDYEING', 'SPENTEX', 'RUCHIRA', 'SUTLEJTEX', 'NAHARSPING', 'SANGAMIND',
            'GTNTEX', 'LOYALTEX', 'BANSWRAS', 'SURYALAXMI', 'PIONEEREMB'],

        'Media': ['ZEEL', 'SUNTV', 'DISHTV', 'TV18BRDCST', 'TVTODAY', 'NAZARA', 'INOXLEISUR',
            'PVRINOX', 'HATHWAY', 'DEN', 'SITI', 'BALAJITELE', 'SARE', 'ENIL',
            'MAGNUM', 'RADIOCITY', 'NDTV', 'NETWORK18'],

        'Agriculture': ['RALLIS', 'DCM', 'UPL', 'COROMANDEL', 'BAYERCROP', 'DEEPAKFERT',
            'GUJSTATE', 'CHAMBLFERT', 'GSFC', 'GNFC', 'FACT', 'RCF', 'NATIONALUM',
            'ZUARI', 'NFL', 'KHADIM', 'KAIRALI'],

        'Aviation': ['INDIGO', 'SPICEJET', 'GLOBALVECT', 'JETAIRWAYS', 'AIRINDIA'],

        'Retail': ['DMART', 'TRENT', 'V2RETAIL', 'VMART', 'SHOPERSTOP', 'SPENCERS',
            'AVENUE', 'PANTALOON', 'ARVINDFASN', 'BATAINDIA', 'LIBERTY',
            'METROBRAND', 'CANTABIL', 'TCNSBRANDS', 'GOCOLORS', 'MAX', 'VBL'],

        'Insurance': ['HDFCLIFE', 'SBILIFE', 'ICICIPRULI', 'MAXLIFE', 'LICI', 'ICICIGI',
            'GICRE', 'NIACL', 'NEWINDIA', 'BAJAJALLZ'],

        'Logistics': ['CONCOR', 'BLUEDART', 'TCI', 'GATI', 'VRL', 'MAHLOG', 'SNOWMAN',
            'DELHIVERY', 'CONTAINER', 'ALLCRGO'],

        'Power': ['NTPC', 'POWERGRID', 'TATAPOWER', 'ADANIPOWER', 'TORNTPOWER', 'JSWENERGY',
            'CESC', 'NHPC', 'SJVN', 'NLCINDIA', 'GIPCL', 'KPIGREEN', 'SUZLON'],

        'Defence': ['HAL', 'BEL', 'BDL', 'MIL', 'DATAPATTERNS', 'PARAS', 'ASTRA', 'MTAR'],

        'Railway': ['IRCON', 'RVNL', 'TEXRAIL', 'TITAGARH', 'JWL', 'CONCOR', 'RAILTEL'],

        'PSU': ['ONGC', 'NTPC', 'COALINDIA', 'IOC', 'BPCL', 'POWERGRID', 'GAIL', 'BHEL',
            'SAIL', 'HAL', 'BEL', 'MMTC', 'STC', 'NMDC', 'NLC', 'SJVN', 'NHPC']
    };

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        stocksPerPage: 25,
        updateInterval: 30000,
        initialLoadBatch: 100,
        maxStocksToLoad: 3500,

        marketCapThresholds: {
            large: 20000,
            mid: 5000,
            small: 500,
            micro: 0
        }
    };

    // ==================== STATE MANAGEMENT ====================
    let allStocksData = [];
    let displayedStocks = [];
    let currentPage = 1;
    let selectedSector = 'all';
    let selectedMarketCap = 'all';
    let selectedRisk = 'all';
    let selectedPerformance = 'all';
    let currentSort = 'market_cap_desc';
    let searchQuery = '';
    let sectorsDistribution = {};
    let isLoading = true;

    // ==================== STOCK DATA GENERATION ====================
    function categorizeStock(stockName, symbol) {
        const stockNameUpper = (stockName || '').toString().toUpperCase();
        const symbolUpper = (symbol || '').toString().toUpperCase();

        // 1️⃣ Exact symbol match first (fast & accurate)
        for (const [sector, symbols] of Object.entries(SECTOR_MAPPING)) {
            if (symbols.includes(symbolUpper)) {
                return sector;
            }
        }

        // 2️⃣ Keyword-based fallback
        if (stockNameUpper.includes('BANK')) return 'Banking';
        if (stockNameUpper.includes('FIN')) return 'Finance';
        if (stockNameUpper.includes('PHARMA') || stockNameUpper.includes('DRUG')) return 'Pharma';
        if (stockNameUpper.includes('TECH') || stockNameUpper.includes('SOFTWARE')) return 'IT';
        if (stockNameUpper.includes('AUTO') || stockNameUpper.includes('MOTOR')) return 'Automobile';
        if (stockNameUpper.includes('OIL') || stockNameUpper.includes('GAS')) return 'Oil & Gas';
        if (stockNameUpper.includes('POWER')) return 'Power';
        if (stockNameUpper.includes('STEEL') || stockNameUpper.includes('METAL')) return 'Metals';
        if (stockNameUpper.includes('CEMENT')) return 'Cement';
        if (stockNameUpper.includes('CHEM')) return 'Chemicals';
        if (stockNameUpper.includes('TEXTILE') || stockNameUpper.includes('FABRIC')) return 'Textiles';
        if (stockNameUpper.includes('REAL ESTATE') || stockNameUpper.includes('PROPERTY')) return 'Real Estate';
        if (stockNameUpper.includes('INFRA')) return 'Infrastructure';
        if (stockNameUpper.includes('RETAIL') || stockNameUpper.includes('MART')) return 'Retail';
        if (stockNameUpper.includes('MEDIA') || stockNameUpper.includes('TV')) return 'Media';
        if (stockNameUpper.includes('TELECOM')) return 'Telecom';
        if (stockNameUpper.includes('HEALTH') || stockNameUpper.includes('HOSPITAL')) return 'Healthcare';
        if (stockNameUpper.includes('AGRI') || stockNameUpper.includes('FERTILIZER')) return 'Agriculture';
        if (stockNameUpper.includes('AIR') || stockNameUpper.includes('AVIATION')) return 'Aviation';
        if (stockNameUpper.includes('INSURANCE')) return 'Insurance';
        if (stockNameUpper.includes('LOGISTICS') || stockNameUpper.includes('TRANSPORT')) return 'Logistics';
        if (stockNameUpper.includes('DEFENCE') || stockNameUpper.includes('MILITARY')) return 'Defence';
        if (stockNameUpper.includes('RAIL')) return 'Railway';

        // 3️⃣ PSU fallback
        const psuKeywords = ['INDIA', 'CORPORATION', 'AUTHORITY', 'BOARD'];
        if (psuKeywords.some(k => stockNameUpper.includes(k))) {
            return 'PSU';
        }

        // 4️⃣ Final fallback
        return 'Other';
    }

    function getSectorColorClass(sector) {
        const sectorMap = {
            'Banking': 'sector-banking',
            'Finance': 'sector-finance',
            'IT': 'sector-it',
            'Automobile': 'sector-automobile',
            'Pharma': 'sector-pharma',
            'FMCG': 'sector-fmcg',
            'Energy': 'sector-energy',
            'Metals': 'sector-metals',
            'Infrastructure': 'sector-infrastructure',
            'Telecom': 'sector-telecom',
            'Real Estate': 'sector-real-estate',
            'Healthcare': 'sector-healthcare',
            'Chemicals': 'sector-chemicals',
            'Consumer Goods': 'sector-consumer-goods',
            'Oil & Gas': 'sector-oil-gas',
            'Cement': 'sector-cement',
            'Textiles': 'sector-textiles',
            'Media': 'sector-media',
            'Agriculture': 'sector-agriculture',
            'Aviation': 'sector-aviation',
            'Retail': 'sector-retail',
            'Insurance': 'sector-insurance',
            'Logistics': 'sector-logistics',
            'Power': 'sector-power',
            'Defence': 'sector-defence',
            'Railway': 'sector-railway',
            'PSU': 'sector-psu'
        };

        return sectorMap[sector] || 'sector-other';
    }

    // ==================== REAL INDIAN STOCKS DATABASE ====================
    const REAL_INDIAN_STOCKS = [
        // NIFTY 50 & Large Caps
        { symbol: 'RELIANCE', name: 'Reliance Industries Limited' },
        { symbol: 'TCS', name: 'Tata Consultancy Services Limited' },
        { symbol: 'HDFCBANK', name: 'HDFC Bank Limited' },
        { symbol: 'INFY', name: 'Infosys Limited' },
        { symbol: 'ICICIBANK', name: 'ICICI Bank Limited' },
        { symbol: 'HINDUNILVR', name: 'Hindustan Unilever Limited' },
        { symbol: 'ITC', name: 'ITC Limited' },
        { symbol: 'SBIN', name: 'State Bank of India' },
        { symbol: 'BHARTIARTL', name: 'Bharti Airtel Limited' },
        { symbol: 'KOTAKBANK', name: 'Kotak Mahindra Bank Limited' },
        { symbol: 'LT', name: 'Larsen & Toubro Limited' },
        { symbol: 'AXISBANK', name: 'Axis Bank Limited' },
        { symbol: 'BAJFINANCE', name: 'Bajaj Finance Limited' },
        { symbol: 'ASIANPAINT', name: 'Asian Paints Limited' },
        { symbol: 'MARUTI', name: 'Maruti Suzuki India Limited' },
        { symbol: 'TITAN', name: 'Titan Company Limited' },
        { symbol: 'SUNPHARMA', name: 'Sun Pharmaceutical Industries Limited' },
        { symbol: 'ULTRACEMCO', name: 'UltraTech Cement Limited' },
        { symbol: 'NESTLEIND', name: 'Nestle India Limited' },
        { symbol: 'BAJAJFINSV', name: 'Bajaj Finserv Limited' },
        { symbol: 'WIPRO', name: 'Wipro Limited' },
        { symbol: 'M&M', name: 'Mahindra & Mahindra Limited' },
        { symbol: 'HCLTECH', name: 'HCL Technologies Limited' },
        { symbol: 'TATAMOTORS', name: 'Tata Motors Limited' },
        { symbol: 'TATASTEEL', name: 'Tata Steel Limited' },
        { symbol: 'ONGC', name: 'Oil and Natural Gas Corporation Limited' },
        { symbol: 'NTPC', name: 'NTPC Limited' },
        { symbol: 'POWERGRID', name: 'Power Grid Corporation of India Limited' },
        { symbol: 'JSWSTEEL', name: 'JSW Steel Limited' },
        { symbol: 'INDUSINDBK', name: 'IndusInd Bank Limited' },
        { symbol: 'TECHM', name: 'Tech Mahindra Limited' },
        { symbol: 'HINDALCO', name: 'Hindalco Industries Limited' },
        { symbol: 'COALINDIA', name: 'Coal India Limited' },
        { symbol: 'ADANIENT', name: 'Adani Enterprises Limited' },
        { symbol: 'ADANIPORTS', name: 'Adani Ports and Special Economic Zone Limited' },
        { symbol: 'HEROMOTOCO', name: 'Hero MotoCorp Limited' },
        { symbol: 'DIVISLAB', name: 'Divi\'s Laboratories Limited' },
        { symbol: 'DRREDDY', name: 'Dr. Reddy\'s Laboratories Limited' },
        { symbol: 'CIPLA', name: 'Cipla Limited' },
        { symbol: 'BRITANNIA', name: 'Britannia Industries Limited' },
        { symbol: 'EICHERMOT', name: 'Eicher Motors Limited' },
        { symbol: 'GRASIM', name: 'Grasim Industries Limited' },
        { symbol: 'SHREECEM', name: 'Shree Cement Limited' },
        { symbol: 'APOLLOHOSP', name: 'Apollo Hospitals Enterprise Limited' },
        { symbol: 'TATACONSUM', name: 'Tata Consumer Products Limited' },
        { symbol: 'VEDL', name: 'Vedanta Limited' },
        { symbol: 'BPCL', name: 'Bharat Petroleum Corporation Limited' },
        { symbol: 'IOC', name: 'Indian Oil Corporation Limited' },
        { symbol: 'HINDZINC', name: 'Hindustan Zinc Limited' },
        { symbol: 'MAZDOCK', name: 'Mazagon Dock Shipbuilders Limited' },

        // Banking Sector
        { symbol: 'BANDHANBNK', name: 'Bandhan Bank Limited' },
        { symbol: 'FEDERALBNK', name: 'The Federal Bank Limited' },
        { symbol: 'IDFCFIRSTB', name: 'IDFC First Bank Limited' },
        { symbol: 'RBLBANK', name: 'RBL Bank Limited' },
        { symbol: 'YESBANK', name: 'Yes Bank Limited' },
        { symbol: 'BANKBARODA', name: 'Bank of Baroda' },
        { symbol: 'PNB', name: 'Punjab National Bank' },
        { symbol: 'CANBK', name: 'Canara Bank' },
        { symbol: 'UNIONBANK', name: 'Union Bank of India' },
        { symbol: 'BANKINDIA', name: 'Bank of India' },
        { symbol: 'INDIANB', name: 'Indian Bank' },
        { symbol: 'CENTRALBK', name: 'Central Bank of India' },
        { symbol: 'UCOBANK', name: 'UCO Bank' },
        { symbol: 'MAHABANK', name: 'Bank of Maharashtra' },
        { symbol: 'AUBANK', name: 'AU Small Finance Bank Limited' },
        { symbol: 'EQUITAS', name: 'Equitas Small Finance Bank Limited' },
        { symbol: 'UJJIVANSFB', name: 'Ujjivan Small Finance Bank Limited' },
        { symbol: 'DCBBANK', name: 'DCB Bank Limited' },
        { symbol: 'KARURVYSYA', name: 'Karur Vysya Bank Limited' },
        { symbol: 'SOUTHBANK', name: 'South Indian Bank Limited' },
        { symbol: 'JKBANK', name: 'Jammu & Kashmir Bank Limited' },
        { symbol: 'CUB', name: 'City Union Bank Limited' },

        // IT Sector
        { symbol: 'LTIM', name: 'LTIMindtree Limited' },
        { symbol: 'PERSISTENT', name: 'Persistent Systems Limited' },
        { symbol: 'COFORGE', name: 'Coforge Limited' },
        { symbol: 'MPHASIS', name: 'MPhasis Limited' },
        { symbol: 'LTTS', name: 'L&T Technology Services Limited' },
        { symbol: 'TATAELXSI', name: 'Tata Elxsi Limited' },
        { symbol: 'ZENSARTECH', name: 'Zensar Technologies Limited' },
        { symbol: 'CYIENT', name: 'Cyient Limited' },
        { symbol: 'SONATSOFTW', name: 'Sonata Software Limited' },
        { symbol: 'INTELLECT', name: 'Intellect Design Arena Limited' },
        { symbol: 'ROUTE', name: 'Route Mobile Limited' },
        { symbol: 'TANLA', name: 'Tanla Platforms Limited' },
        { symbol: 'AFFLE', name: 'Affle (India) Limited' },
        { symbol: 'NAUKRI', name: 'Info Edge (India) Limited' },
        { symbol: 'ZOMATO', name: 'Zomato Limited' },
        { symbol: 'PAYTM', name: 'One 97 Communications Limited' },

        // Pharma & Healthcare
        { symbol: 'LUPIN', name: 'Lupin Limited' },
        { symbol: 'BIOCON', name: 'Biocon Limited' },
        { symbol: 'TORNTPHARM', name: 'Torrent Pharmaceuticals Limited' },
        { symbol: 'AUROPHARMA', name: 'Aurobindo Pharma Limited' },
        { symbol: 'ALKEM', name: 'Alkem Laboratories Limited' },
        { symbol: 'GLENMARK', name: 'Glenmark Pharmaceuticals Limited' },
        { symbol: 'CADILAHC', name: 'Cadila Healthcare Limited (Zydus)' },
        { symbol: 'IPCALAB', name: 'IPCA Laboratories Limited' },
        { symbol: 'LAURUSLABS', name: 'Laurus Labs Limited' },
        { symbol: 'GRANULES', name: 'Granules India Limited' },
        { symbol: 'NATCOPHARM', name: 'Natco Pharma Limited' },
        { symbol: 'AJANTPHARM', name: 'Ajanta Pharma Limited' },
        { symbol: 'SANOFI', name: 'Sanofi India Limited' },
        { symbol: 'PFIZER', name: 'Pfizer Limited' },
        { symbol: 'ABBOTINDIA', name: 'Abbott India Limited' },
        { symbol: 'GLAXO', name: 'GlaxoSmithKline Pharmaceuticals Limited' },
        { symbol: 'FORTIS', name: 'Fortis Healthcare Limited' },
        { symbol: 'MAXHEALTH', name: 'Max Healthcare Institute Limited' },
        { symbol: 'NARAYANA', name: 'Narayana Hrudayalaya Limited' },
        { symbol: 'METROPOLIS', name: 'Metropolis Healthcare Limited' },

        // Auto & Auto Components
        { symbol: 'BAJAJ-AUTO', name: 'Bajaj Auto Limited' },
        { symbol: 'TVSMOTOR', name: 'TVS Motor Company Limited' },
        { symbol: 'ASHOKLEY', name: 'Ashok Leyland Limited' },
        { symbol: 'ESCORTS', name: 'Escorts Kubota Limited' },
        { symbol: 'MRF', name: 'MRF Limited' },
        { symbol: 'APOLLOTYRE', name: 'Apollo Tyres Limited' },
        { symbol: 'CEATLTD', name: 'CEAT Limited' },
        { symbol: 'JKTYRE', name: 'JK Tyre & Industries Limited' },
        { symbol: 'BALKRISIND', name: 'Balkrishna Industries Limited' },
        { symbol: 'MOTHERSON', name: 'Samvardhana Motherson International Limited' },
        { symbol: 'BHARATFORG', name: 'Bharat Forge Limited' },
        { symbol: 'BOSCHLTD', name: 'Bosch Limited' },
        { symbol: 'EXIDEIND', name: 'Exide Industries Limited' },
        { symbol: 'AMARAJABAT', name: 'Amara Raja Energy & Mobility Limited' },

        // FMCG & Consumer
        { symbol: 'DABUR', name: 'Dabur India Limited' },
        { symbol: 'GODREJCP', name: 'Godrej Consumer Products Limited' },
        { symbol: 'MARICO', name: 'Marico Limited' },
        { symbol: 'COLPAL', name: 'Colgate-Palmolive (India) Limited' },
        { symbol: 'EMAMILTD', name: 'Emami Limited' },
        { symbol: 'RADICO', name: 'Radico Khaitan Limited' },
        { symbol: 'UBL', name: 'United Breweries Limited' },
        { symbol: 'VBL', name: 'Varun Beverages Limited' },
        { symbol: 'JUBLFOOD', name: 'Jubilant Foodworks Limited' },
        { symbol: 'DMART', name: 'Avenue Supermarts Limited' },
        { symbol: 'TRENT', name: 'Trent Limited' },
        { symbol: 'BATAINDIA', name: 'Bata India Limited' },
        { symbol: 'PAGEIND', name: 'Page Industries Limited' },

        // Metals & Mining
        { symbol: 'JINDALSTEL', name: 'Jindal Steel & Power Limited' },
        { symbol: 'SAIL', name: 'Steel Authority of India Limited' },
        { symbol: 'NMDC', name: 'NMDC Limited' },
        { symbol: 'HINDCOPPER', name: 'Hindustan Copper Limited' },
        { symbol: 'NATIONALUM', name: 'National Aluminium Company Limited' },
        { symbol: 'MOIL', name: 'MOIL Limited' },
        { symbol: 'RATNAMANI', name: 'Ratnamani Metals & Tubes Limited' },
        { symbol: 'APLAPOLLO', name: 'APL Apollo Tubes Limited' },

        // Energy & Power
        { symbol: 'GAIL', name: 'GAIL (India) Limited' },
        { symbol: 'PETRONET', name: 'Petronet LNG Limited' },
        { symbol: 'IGL', name: 'Indraprastha Gas Limited' },
        { symbol: 'MGL', name: 'Mahanagar Gas Limited' },
        { symbol: 'ADANIGAS', name: 'Adani Total Gas Limited' },
        { symbol: 'GSPL', name: 'Gujarat State Petronet Limited' },
        { symbol: 'HINDPETRO', name: 'Hindustan Petroleum Corporation Limited' },
        { symbol: 'TATAPOWER', name: 'Tata Power Company Limited' },
        { symbol: 'ADANIPOWER', name: 'Adani Power Limited' },
        { symbol: 'JSWENERGY', name: 'JSW Energy Limited' },
        { symbol: 'TORNTPOWER', name: 'Torrent Power Limited' },
        { symbol: 'NHPC', name: 'NHPC Limited' },
        { symbol: 'SJVN', name: 'SJVN Limited' },
        { symbol: 'NLCINDIA', name: 'NLC India Limited' },
        { symbol: 'ADANIGREEN', name: 'Adani Green Energy Limited' },
        { symbol: 'SUZLON', name: 'Suzlon Energy Limited' },

        // Cement
        { symbol: 'ACC', name: 'ACC Limited' },
        { symbol: 'AMBUJACEM', name: 'Ambuja Cements Limited' },
        { symbol: 'RAMCOCEM', name: 'The Ramco Cements Limited' },
        { symbol: 'DALBHARAT', name: 'Dalmia Bharat Limited' },
        { symbol: 'JKCEMENT', name: 'JK Cement Limited' },
        { symbol: 'HEIDELBERG', name: 'Heidelberg Cement India Limited' },
        { symbol: 'JKLAKSHMI', name: 'JK Lakshmi Cement Limited' },

        // Finance & NBFCs
        { symbol: 'CHOLAFIN', name: 'Cholamandalam Investment and Finance Company Limited' },
        { symbol: 'MUTHOOTFIN', name: 'Muthoot Finance Limited' },
        { symbol: 'MANAPPURAM', name: 'Manappuram Finance Limited' },
        { symbol: 'SHRIRAMFIN', name: 'Shriram Finance Limited' },
        { symbol: 'PFC', name: 'Power Finance Corporation Limited' },
        { symbol: 'RECLTD', name: 'REC Limited' },
        { symbol: 'HDFCAMC', name: 'HDFC Asset Management Company Limited' },
        { symbol: 'HDFCLIFE', name: 'HDFC Life Insurance Company Limited' },
        { symbol: 'SBILIFE', name: 'SBI Life Insurance Company Limited' },
        { symbol: 'ICICIPRULI', name: 'ICICI Prudential Life Insurance Company Limited' },
        { symbol: 'ICICIGI', name: 'ICICI Lombard General Insurance Company Limited' },
        { symbol: 'LICI', name: 'Life Insurance Corporation of India' },

        // Real Estate
        { symbol: 'DLF', name: 'DLF Limited' },
        { symbol: 'GODREJPROP', name: 'Godrej Properties Limited' },
        { symbol: 'OBEROIRLTY', name: 'Oberoi Realty Limited' },
        { symbol: 'PRESTIGE', name: 'Prestige Estates Projects Limited' },
        { symbol: 'BRIGADE', name: 'Brigade Enterprises Limited' },
        { symbol: 'SOBHA', name: 'Sobha Limited' },
        { symbol: 'PHOENIXLTD', name: 'The Phoenix Mills Limited' },

        // Chemicals
        { symbol: 'UPL', name: 'UPL Limited' },
        { symbol: 'PIDILITIND', name: 'Pidilite Industries Limited' },
        { symbol: 'SRF', name: 'SRF Limited' },
        { symbol: 'TATACHEM', name: 'Tata Chemicals Limited' },
        { symbol: 'AARTIIND', name: 'Aarti Industries Limited' },
        { symbol: 'DEEPAKNTR', name: 'Deepak Nitrite Limited' },
        { symbol: 'NAVINFLUOR', name: 'Navin Fluorine International Limited' },
        { symbol: 'GUJALKALI', name: 'Gujarat Alkalies and Chemicals Limited' },
        { symbol: 'GNFC', name: 'Gujarat Narmada Valley Fertilizers & Chemicals Limited' },
        { symbol: 'VINATIORGA', name: 'Vinati Organics Limited' },
        { symbol: 'PIIND', name: 'PI Industries Limited' },
        { symbol: 'BALRAMCHIN', name: 'Balrampur Chini Mills Limited' },

        // Infrastructure & Construction
        { symbol: 'NCC', name: 'NCC Limited' },
        { symbol: 'IRB', name: 'IRB Infrastructure Developers Limited' },
        { symbol: 'GMRINFRA', name: 'GMR Infrastructure Limited' },
        { symbol: 'KEC', name: 'KEC International Limited' },
        { symbol: 'NBCC', name: 'NBCC (India) Limited' },
        { symbol: 'IRCON', name: 'IRCON International Limited' },
        { symbol: 'RVNL', name: 'Rail Vikas Nigam Limited' },
        { symbol: 'ASHOKA', name: 'Ashoka Buildcon Limited' },

        // Telecom
        { symbol: 'IDEA', name: 'Vodafone Idea Limited' },
        { symbol: 'TATACOMM', name: 'Tata Communications Limited' },
        { symbol: 'INDUSTOWER', name: 'Indus Towers Limited' },
        { symbol: 'HFCL', name: 'HFCL Limited' },

        // Textiles
        { symbol: 'ARVIND', name: 'Arvind Limited' },
        { symbol: 'KPRMILL', name: 'KPR Mill Limited' },
        { symbol: 'VARDHACRLC', name: 'Vardhman Textiles Limited' },
        { symbol: 'TRIDENT', name: 'Trident Limited' },
        { symbol: 'WELSPUNIND', name: 'Welspun India Limited' },

        // Media & Entertainment
        { symbol: 'ZEEL', name: 'Zee Entertainment Enterprises Limited' },
        { symbol: 'SUNTV', name: 'Sun TV Network Limited' },
        { symbol: 'PVRINOX', name: 'PVR INOX Limited' },
        { symbol: 'NAZARA', name: 'Nazara Technologies Limited' },
        { symbol: 'TIPS', name: 'Tips Industries Limited' },

        // Defence & PSUs
        { symbol: 'HAL', name: 'Hindustan Aeronautics Limited' },
        { symbol: 'BEL', name: 'Bharat Electronics Limited' },
        { symbol: 'BDL', name: 'Bharat Dynamics Limited' },
        { symbol: 'BEML', name: 'BEML Limited' },
        { symbol: 'COCHINSHIP', name: 'Cochin Shipyard Limited' },
        { symbol: 'GARDENREACH', name: 'Garden Reach Shipbuilders & Engineers Limited' },
        { symbol: 'GRSE', name: 'Garden Reach Shipbuilders & Engineers Limited' },
        { symbol: 'BHEL', name: 'Bharat Heavy Electricals Limited' },

        // Logistics
        { symbol: 'CONCOR', name: 'Container Corporation of India Limited' },
        { symbol: 'BLUEDART', name: 'Blue Dart Express Limited' },
        { symbol: 'TCI', name: 'Transport Corporation of India Limited' },
        { symbol: 'VRL', name: 'VRL Logistics Limited' },
        { symbol: 'DELHIVERY', name: 'Delhivery Limited' },

        // Retail
        { symbol: 'SHOPERSTOP', name: 'Shoppers Stop Limited' },
        { symbol: 'VMART', name: 'V-Mart Retail Limited' },
        { symbol: 'SPENCERS', name: 'Spencer\'s Retail Limited' },

        // Others
        { symbol: 'HAVELLS', name: 'Havells India Limited' },
        { symbol: 'CROMPTON', name: 'Crompton Greaves Consumer Electricals Limited' },
        { symbol: 'VGUARD', name: 'V-Guard Industries Limited' },
        { symbol: 'SYMPHONY', name: 'Symphony Limited' },
        { symbol: 'VOLTAS', name: 'Voltas Limited' },
        { symbol: 'WHIRLPOOL', name: 'Whirlpool of India Limited' },
        { symbol: 'BLUESTARCO', name: 'Blue Star Limited' },
        { symbol: 'DIXON', name: 'Dixon Technologies (India) Limited' },
        { symbol: 'POLYCAB', name: 'Polycab India Limited' },
        { symbol: 'KEI', name: 'KEI Industries Limited' },
        { symbol: 'BERGEPAINT', name: 'Berger Paints India Limited' },
        { symbol: 'KANSAINER', name: 'Kansai Nerolac Paints Limited' },
        { symbol: 'INDIAMART', name: 'IndiaMART InterMESH Limited' },
        { symbol: 'IRCTC', name: 'Indian Railway Catering and Tourism Corporation Limited' },
        { symbol: 'RAILTEL', name: 'RailTel Corporation of India Limited' },
        { symbol: 'CDSL', name: 'Central Depository Services (India) Limited' },
        { symbol: 'NSDL', name: 'National Securities Depository Limited' },
        { symbol: 'CAMS', name: 'Computer Age Management Services Limited' },
    ];

    function generateStockData(count = 3500) {
        const stocks = [];

        // First, add all real stocks
        REAL_INDIAN_STOCKS.forEach((stockData, index) => {
            const sector = categorizeStock(stockData.name, stockData.symbol);
            const marketCapValue = generateMarketCap(index);
            const marketCapType = getMarketCapType(marketCapValue);
            const riskLevel = getRiskLevel(marketCapType);
            const basePrice = generateInitialPrice(stockData.symbol);
            const change = (Math.random() - 0.5) * 100;
            const changePercent = (change / basePrice) * 100;
            const price = basePrice + change;

            stocks.push({
                id: `stock-${index}`,
                symbol: stockData.symbol,
                name: stockData.name,
                sector,
                marketCap: marketCapValue,
                marketCapType,
                riskLevel,
                price: Math.max(1, price),
                previousClose: basePrice,
                change: change,
                changePercent: changePercent,
                volume: Math.floor(Math.random() * 10000000),
                recommendation: getRecommendation(changePercent, riskLevel),
                lastUpdated: new Date(),
                isLive: false
            });

            sectorsDistribution[sector] = (sectorsDistribution[sector] || 0) + 1;
        });

        // Then generate additional synthetic stocks to reach target count
        const remainingCount = count - REAL_INDIAN_STOCKS.length;
        const companyPrefixes = ['Aditya', 'Alok', 'Ambuja', 'Anil', 'Anmol', 'Arvind', 'Ashok', 'Bajrang',
            'Balaji', 'Bharat', 'Birla', 'Chandra', 'Continental', 'Deepak', 'Dewan', 'Dilip',
            'Emkay', 'Everest', 'Fortune', 'Galaxy', 'Gateway', 'Global', 'Gujarat', 'Hindustan',
            'Imperial', 'Indo', 'Jaiprakash', 'Jain', 'Jindal', 'Kalyani', 'Kirloskar', 'Kumar',
            'Lakshmi', 'Mahindra', 'Modern', 'Mukesh', 'Nagarjuna', 'National', 'Orient', 'Patel',
            'Pratibha', 'Prem', 'Pyramid', 'Raaj', 'Rajesh', 'Ramesh', 'Ratan', 'Renaissance',
            'Sakshi', 'Sanjay', 'Satyam', 'Shah', 'Shanti', 'Sharma', 'Shree', 'Simplex',
            'Sinha', 'Surya', 'Triveni', 'Unitech', 'Unity', 'Vardhman', 'Vijay', 'Vinay',
            'Vishal', 'Vivek', 'Wonder', 'Zenith'];

        const companySuffixes = ['Industries', 'Limited', 'Corporation', 'Enterprises', 'Group',
            'Solutions', 'Technologies', 'Systems', 'Services', 'Holdings', 'Ventures', 'Capital',
            'Finance', 'Bank', 'Motors', 'Steel', 'Power', 'Energy', 'Pharma', 'Healthcare',
            'Textiles', 'Chemicals', 'Polymers', 'Plastics', 'Foods', 'Beverages', 'Agro',
            'Trading', 'Exports', 'Manufacturing', 'Engineering', 'Constructions', 'Developers',
            'Infrastructure', 'Realty', 'Properties', 'Logistics', 'Shipping', 'Aviation'];

        for (let i = 0; i < remainingCount; i++) {
            const prefix = companyPrefixes[Math.floor(Math.random() * companyPrefixes.length)];
            const suffix = companySuffixes[Math.floor(Math.random() * companySuffixes.length)];
            const companyName = `${prefix} ${suffix}`;
            const symbol = generateSymbol(companyName, i + REAL_INDIAN_STOCKS.length);

            const sector = categorizeStock(companyName, symbol);
            const marketCapValue = generateMarketCap(i + REAL_INDIAN_STOCKS.length);
            const marketCapType = getMarketCapType(marketCapValue);
            const riskLevel = getRiskLevel(marketCapType);
            const basePrice = generateInitialPrice(symbol);
            const change = (Math.random() - 0.5) * 100;
            const changePercent = (change / basePrice) * 100;
            const price = basePrice + change;

            stocks.push({
                id: `stock-${i + REAL_INDIAN_STOCKS.length}`,
                symbol: symbol,
                name: companyName,
                sector,
                marketCap: marketCapValue,
                marketCapType,
                riskLevel,
                price: Math.max(1, price),
                previousClose: basePrice,
                change: change,
                changePercent: changePercent,
                volume: Math.floor(Math.random() * 10000000),
                recommendation: getRecommendation(changePercent, riskLevel),
                lastUpdated: new Date(),
                isLive: false
            });

            sectorsDistribution[sector] = (sectorsDistribution[sector] || 0) + 1;
        }

        return stocks;
    }

    function generateSymbol(companyName, index) {
        const words = companyName.split(' ');
        let symbol = '';

        for (const word of words) {
            if (word.length > 0 && symbol.length < 10) {
                symbol += word.charAt(0).toUpperCase();
            }
        }

        if (symbol.length < 3) {
            symbol += (index % 1000).toString().padStart(3, '0');
        }

        return symbol;
    }

    function generateMarketCap(index) {
        if (index < 50) return Math.random() * 100000000000 + 50000000000; // Large Cap
        if (index < 150) return Math.random() * 50000000000 + 10000000000; // Mid Cap
        if (index < 500) return Math.random() * 10000000000 + 1000000000;  // Small Cap
        return Math.random() * 1000000000 + 10000000; // Micro Cap
    }

    function generateInitialPrice(symbol) {
        const hash = symbol.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        return (hash % 5000) + 100;
    }

    function getMarketCapType(marketCap) {
        if (marketCap >= CONFIG.marketCapThresholds.large * 10000000) return 'large';
        if (marketCap >= CONFIG.marketCapThresholds.mid * 10000000) return 'mid';
        if (marketCap >= CONFIG.marketCapThresholds.small * 10000000) return 'small';
        return 'micro';
    }

    function getRiskLevel(marketCapType) {
        switch(marketCapType) {
            case 'large': return 'low';
            case 'mid': return 'medium';
            default: return 'high';
        }
    }

    function getRecommendation(changePercent, riskLevel) {
        let recommendation;

        if (changePercent > 5) {
            recommendation = riskLevel === 'high' ? 'Buy' : 'Strong Buy';
        } else if (changePercent > 2) {
            recommendation = 'Buy';
        } else if (changePercent > -2) {
            recommendation = 'Hold';
        } else if (changePercent > -5) {
            recommendation = 'Sell';
        } else {
            recommendation = riskLevel === 'high' ? 'Strong Sell' : 'Sell';
        }

        const classes = {
            'Strong Buy': 'recommendation-strong-buy',
            'Buy': 'recommendation-buy',
            'Hold': 'recommendation-hold',
            'Sell': 'recommendation-sell',
            'Strong Sell': 'recommendation-strong-sell'
        };

        return {
            text: recommendation,
            class: classes[recommendation]
        };
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('🚀 Initializing Indian Stocks Dashboard...');
        showLoadingState();

        try {
            // Check backend connection first
            try {
                const healthCheck = await fetch('http://localhost:3000/api/stock?symbol=TCS');
                if (!healthCheck.ok) {
                    throw new Error('Backend not responding');
                }
                console.log('✅ Backend server connected');
            } catch (backendError) {
                console.error('❌ Backend server not running!');
                document.getElementById('loadingProgress').innerHTML = `
                    <div class="text-red-400 font-bold mb-2">⚠️ Backend Server Not Running</div>
                    <div class="text-sm text-gray-400">Please start your backend server:</div>
                    <div class="text-sm text-blue-400 mt-2 font-mono">
                        cd visiontrade-full<br>
                        node server.js
                    </div>
                    <div class="text-sm text-gray-500 mt-2">Then refresh this page</div>
                `;
                return;
            }

            await loadMarketIndices();
            await loadAllStocks();
            initializeFilters();
            startAutoRefresh();
            hideLoadingState();
            console.log('✅ Dashboard initialized successfully');
        } catch (error) {
            console.error('Initialization error:', error);
            document.getElementById('loadingProgress').textContent = 'Error: ' + error.message;
        }
    });

    async function loadAllStocks() {
        console.log('📥 Generating stock data...');

        allStocksData = generateStockData(3500);

        // Update UI first with placeholder data
        updateSectorChips();
        updateMarketCapCounts();
        applyFiltersAndRender();

        document.getElementById('totalStocks').textContent = allStocksData.length.toLocaleString();
        document.getElementById('liveStocksCount').textContent = '0';

        console.log('✅ Loaded', allStocksData.length, 'stocks');
        console.log('💰 Fetching real prices from Yahoo Finance...');

        // Fetch real prices for visible stocks
        await fetchRealPricesInBatches();
    }

    async function fetchRealPricesInBatches() {
        const batchSize = 10; // Fetch 10 stocks at a time
        let liveCount = 0;

        // Prioritize real stocks first
        const realStockSymbols = REAL_INDIAN_STOCKS.map(s => s.symbol);
        const realStocks = allStocksData.filter(s => realStockSymbols.includes(s.symbol));

        console.log(`🔍 Fetching real prices for ${realStocks.length} stocks from backend...`);

        for (let i = 0; i < realStocks.length; i += batchSize) {
            const batch = realStocks.slice(i, i + batchSize);

            await Promise.all(batch.map(async (stock) => {
                try {
                    // Call your backend API
                    const response = await fetch(`http://localhost:3000/api/stock?symbol=${stock.symbol}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data && data.price && data.price > 0) {
                        const previousClose = data.price / (1 + (data.change / 100));

                        stock.price = data.price;
                        stock.previousClose = previousClose;
                        stock.change = data.price - previousClose;
                        stock.changePercent = data.change;
                        stock.marketCap = data.marketCap || stock.marketCap;
                        stock.peRatio = data.pe || null;
                        stock.recommendation = getRecommendation(stock.changePercent, stock.riskLevel);
                        stock.isLive = true;
                        liveCount++;

                        console.log(`✅ ${stock.symbol}: ₹${stock.price.toFixed(2)} (${stock.changePercent > 0 ? '+' : ''}${stock.changePercent.toFixed(2)}%)`);
                    }
                } catch (error) {
                    console.warn(`⚠️ Failed to fetch ${stock.symbol}: ${error.message}`);
                }
            }));

            // Update the display after each batch
            document.getElementById('liveStocksCount').textContent = liveCount;
            if (i === 0) {
                applyFiltersAndRender(); // Refresh display with first batch
            }

            // Small delay to avoid overwhelming the backend
            await new Promise(resolve => setTimeout(resolve, 100));

            // Update progress
            const progress = Math.min(100, Math.round((i + batchSize) / realStocks.length * 100));
            document.getElementById('loadingProgress').textContent =
                `Fetching real prices: ${liveCount}/${realStocks.length} stocks (${progress}%)`;
        }

        console.log(`✅ Successfully fetched ${liveCount} real stock prices`);
        applyFiltersAndRender(); // Final refresh
    }

    async function loadMarketIndices() {
        try {
            // Fetch NIFTY 50
            try {
                const niftyResponse = await fetch('http://localhost:3000/api/stock?symbol=NSEI');
                if (niftyResponse.ok) {
                    const niftyData = await niftyResponse.json();
                    const previousClose = niftyData.price / (1 + (niftyData.change / 100));
                    updateIndexDisplay('nifty', niftyData.price, previousClose);
                } else {
                    throw new Error('NIFTY fetch failed');
                }
            } catch (niftyError) {
                console.warn('⚠️ NIFTY fetch failed');
                const niftyValue = 23800; // Approximate current value
                updateIndexDisplay('nifty', niftyValue, 23700);
            }

            // Fetch SENSEX
            try {
                const sensexResponse = await fetch('http://localhost:3000/api/stock?symbol=SENSEX');
                if (sensexResponse.ok) {
                    const sensexData = await sensexResponse.json();
                    const previousClose = sensexData.price / (1 + (sensexData.change / 100));
                    updateIndexDisplay('sensex', sensexData.price, previousClose);
                } else {
                    throw new Error('SENSEX fetch failed');
                }
            } catch (sensexError) {
                console.warn('⚠️ SENSEX fetch failed');
                const sensexValue = 78600; // Approximate current value
                updateIndexDisplay('sensex', sensexValue, 78400);
            }

            updateMarketStatus();
            updateLastUpdated();
        } catch (error) {
            console.error('Error loading market indices:', error);
            // Use approximate current values as fallback
            updateIndexDisplay('nifty', 23800, 23700);
            updateIndexDisplay('sensex', 78600, 78400);
        }
    }

    function updateIndexDisplay(index, currentPrice, previousClose) {
        const change = currentPrice - previousClose;
        const changePercent = (change / previousClose) * 100;
        const isPositive = change >= 0;

        const formattedPrice = index === 'sensex'
            ? currentPrice.toLocaleString('en-IN', {maximumFractionDigits: 0})
            : currentPrice.toFixed(2);

        const formattedChange = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePercent.toFixed(2)}%)`;

        document.getElementById(`${index}Value`).textContent = formattedPrice;
        document.getElementById(`${index}Change`).innerHTML = `
            <span class="${isPositive ? 'text-green-400' : 'text-red-400'} font-semibold">
                ${formattedChange}
            </span>
        `;
        document.getElementById(`${index}Status`).innerHTML = `
            <i class="fas fa-circle text-green-400 mr-1"></i> Live
        `;
    }

    // ==================== SECTOR MANAGEMENT ====================
    function updateSectorChips() {
        const container = document.getElementById('sectorsContainer');
        const moreContainer = document.getElementById('moreSectors');

        container.innerHTML = '<div class="sector-chip px-4 py-2 rounded-full border border-blue-600 text-blue-400 bg-blue-900/20 active" onclick="filterBySector(\'all\')">All Sectors</div>';
        moreContainer.innerHTML = '';

        const sectorsWithStocks = Object.entries(sectorsDistribution)
            .filter(([sector, count]) => count > 0)
            .sort((a, b) => b[1] - a[1]);

        sectorsWithStocks.forEach(([sector, count], index) => {
            const chip = document.createElement('div');
            const sectorClass = getSectorColorClass(sector);

            chip.className = `${sectorClass} sector-chip px-4 py-2 rounded-full text-gray-300 hover:text-white cursor-pointer border`;
            chip.innerHTML = `
                <span class="font-medium">${sector}</span>
                <span class="text-xs bg-gray-800 rounded-full px-2 py-0.5 ml-2">${count}</span>
            `;

            chip.addEventListener('click', () => filterBySector(sector));

            if (index < 8) {
                container.appendChild(chip);
            } else {
                moreContainer.appendChild(chip);
            }
        });

        const totalSectors = sectorsWithStocks.length;
        document.getElementById('sectorsCount').textContent = `${totalSectors}+`;
        document.getElementById('sectorCount').textContent = `${totalSectors} sectors identified`;
    }

    function updateMarketCapCounts() {
        const counts = {
            all: allStocksData.length,
            large: allStocksData.filter(s => s.marketCapType === 'large').length,
            mid: allStocksData.filter(s => s.marketCapType === 'mid').length,
            small: allStocksData.filter(s => s.marketCapType === 'small' || s.marketCapType === 'micro').length
        };

        document.getElementById('capCountAll').textContent = counts.all.toLocaleString() + '+';
        document.getElementById('capCountLarge').textContent = counts.large.toLocaleString() + '+';
        document.getElementById('capCountMid').textContent = counts.mid.toLocaleString() + '+';
        document.getElementById('capCountSmall').textContent = counts.small.toLocaleString() + '+';
    }

    // ==================== FILTERING & RENDERING ====================
    function applyFiltersAndRender() {
        if (allStocksData.length === 0) {
            showEmptyState();
            return;
        }

        displayedStocks = allStocksData.filter(stock => {
            if (selectedMarketCap !== 'all' && stock.marketCapType !== selectedMarketCap) return false;
            if (selectedSector !== 'all' && stock.sector !== selectedSector) return false;
            if (selectedRisk !== 'all' && stock.riskLevel !== selectedRisk) return false;

            if (selectedPerformance !== 'all') {
                if (selectedPerformance === 'gainers' && stock.changePercent <= 0) return false;
                if (selectedPerformance === 'losers' && stock.changePercent >= 0) return false;
                if (selectedPerformance === 'active' && stock.volume < 1000000) return false;
            }

            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                if (!stock.symbol.toLowerCase().includes(query) &&
                    !stock.name.toLowerCase().includes(query) &&
                    !stock.sector.toLowerCase().includes(query)) {
                    return false;
                }
            }

            return true;
        });

        applySorting();
        updateTableInfo();
        renderStocksTable();
    }

    function applySorting() {
        switch(currentSort) {
            case 'market_cap_desc':
                displayedStocks.sort((a, b) => b.marketCap - a.marketCap);
                break;
            case 'market_cap_asc':
                displayedStocks.sort((a, b) => a.marketCap - b.marketCap);
                break;
            case 'change_desc':
                displayedStocks.sort((a, b) => b.changePercent - a.changePercent);
                break;
            case 'change_asc':
                displayedStocks.sort((a, b) => a.changePercent - b.changePercent);
                break;
            case 'price_desc':
                displayedStocks.sort((a, b) => b.price - a.price);
                break;
            case 'price_asc':
                displayedStocks.sort((a, b) => a.price - b.price);
                break;
            case 'name_asc':
                displayedStocks.sort((a, b) => a.name.localeCompare(b.name));
                break;
            case 'name_desc':
                displayedStocks.sort((a, b) => b.name.localeCompare(a.name));
                break;
        }
    }

    function renderStocksTable() {
        const tbody = document.getElementById('stocksTableBody');

        if (displayedStocks.length === 0) {
            showEmptyState();
            return;
        }

        hideEmptyState();

        const startIndex = (currentPage - 1) * CONFIG.stocksPerPage;
        const endIndex = startIndex + CONFIG.stocksPerPage;
        const pageStocks = displayedStocks.slice(startIndex, endIndex);

        tbody.innerHTML = '';

        pageStocks.forEach((stock, index) => {
            const row = createStockRow(stock, startIndex + index + 1);
            tbody.appendChild(row);
        });

        updatePagination();
    }

    function createStockRow(stock, index) {
        const row = document.createElement('tr');
        row.className = 'stock-row border-b border-gray-700 hover:bg-gray-750';

        const marketCapFormatted = formatMarketCap(stock.marketCap);
        const marketCapClass = getMarketCapClass(stock.marketCapType);
        const sectorColorClass = getSectorColorClass(stock.sector);

        row.innerHTML = `
            <td class="py-4 px-6 sticky left-0 bg-gray-800 z-10">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-lg ${sectorColorClass} border flex items-center justify-center mr-3">
                        <span class="font-bold text-white">${stock.symbol.charAt(0)}</span>
                    </div>
                    <div>
                        <div class="flex items-center">
                            <span class="font-bold text-white mr-2">${stock.symbol}</span>
                        </div>
                        <div class="text-sm text-gray-400 truncate max-w-[200px]">${stock.name}</div>
                    </div>
                </div>
            </td>
            <td class="py-4 px-6">
                <div class="${sectorColorClass} px-3 py-1 rounded-full text-xs font-semibold inline-block border">
                    ${stock.sector}
                </div>
            </td>
            <td class="py-4 px-6">
                <div class="${marketCapClass} inline-block">${marketCapFormatted}</div>
                <div class="text-xs text-gray-500 mt-1">${stock.marketCapType.toUpperCase()} CAP</div>
            </td>
            <td class="py-4 px-6">
                <span class="${stock.recommendation.class}">${stock.recommendation.text}</span>
            </td>
            <td class="py-4 px-6">
                <span class="${stock.riskLevel === 'low' ? 'risk-low' : stock.riskLevel === 'medium' ? 'risk-medium' : 'risk-high'}">
                    ${stock.riskLevel.toUpperCase()}
                </span>
            </td>
            <td class="py-4 px-6">
                <div class="font-bold text-white stock-price">₹${formatNumber(stock.price)}</div>
                <div class="text-sm ${stock.change >= 0 ? 'positive-change' : 'negative-change'}">
                    ${stock.change >= 0 ? '+' : ''}₹${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                </div>
            </td>
            <td class="py-4 px-6 sticky right-0 bg-gray-800 z-10">
                <button onclick="analyzeStock('${stock.symbol}')"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors w-full">
                    <i class="fas fa-chart-bar mr-2"></i> Analyze
                </button>
            </td>
        `;

        return row;
    }

    function getMarketCapClass(type) {
        const classes = {
            'large': 'large-cap',
            'mid': 'mid-cap',
            'small': 'small-cap',
            'micro': 'micro-cap'
        };
        return classes[type] || 'large-cap';
    }

    function formatMarketCap(value) {
        if (value >= 100000000000) return '₹' + (value / 100000000000).toFixed(1) + 'L Cr';
        if (value >= 10000000000) return '₹' + (value / 10000000000).toFixed(1) + 'K Cr';
        if (value >= 1000000000) return '₹' + (value / 1000000000).toFixed(1) + ' Cr';
        if (value >= 10000000) return '₹' + (value / 10000000).toFixed(1) + ' L';
        return '₹' + (value / 100000).toFixed(1) + ' K';
    }

    function formatNumber(num) {
        return num.toFixed(2);
    }

    // ==================== UI STATE MANAGEMENT ====================
    function showLoadingState() {
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        isLoading = true;
    }

    function hideLoadingState() {
        document.getElementById('loadingState').classList.add('hidden');
        isLoading = false;
    }

    function showEmptyState() {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('stocksTableBody').innerHTML = '';
        document.getElementById('loadingState').classList.add('hidden');
    }

    function hideEmptyState() {
        document.getElementById('emptyState').classList.add('hidden');
    }

    function updateTableInfo() {
        const total = displayedStocks.length;
        const start = Math.min((currentPage - 1) * CONFIG.stocksPerPage + 1, total);
        const end = Math.min(currentPage * CONFIG.stocksPerPage, total);

        document.getElementById('tableSubtitle').textContent =
            `Showing ${start}-${end} of ${total.toLocaleString()} stocks`;

        let title = 'All Stocks';
        if (selectedSector !== 'all') title = `${selectedSector} Stocks`;
        if (selectedMarketCap !== 'all') title = `${selectedMarketCap.charAt(0).toUpperCase() + selectedMarketCap.slice(1)} Cap Stocks`;
        document.getElementById('tableTitle').textContent = title;

        document.getElementById('searchResultsCount').textContent = total.toLocaleString();
    }

    // ==================== EVENT HANDLERS ====================
    function setupEventListeners() {
        document.getElementById('searchStocks').addEventListener('input', (e) => {
            searchQuery = e.target.value.trim();
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                currentPage = 1;
                applyFiltersAndRender();
            }, 300);
        });

        document.getElementById('sortBy').addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFiltersAndRender();
        });

        document.getElementById('riskFilter').addEventListener('change', (e) => {
            selectedRisk = e.target.value;
            applyFiltersAndRender();
        });

        document.getElementById('performanceFilter').addEventListener('change', (e) => {
            selectedPerformance = e.target.value;
            applyFiltersAndRender();
        });

        document.getElementById('toggleSectors').addEventListener('click', function() {
            const moreSectors = document.getElementById('moreSectors');
            const isHidden = moreSectors.classList.contains('hidden');

            if (isHidden) {
                moreSectors.classList.remove('hidden');
                moreSectors.classList.add('flex');
                this.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
            } else {
                moreSectors.classList.add('hidden');
                moreSectors.classList.remove('flex');
                this.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Show All Sectors';
            }
        });

        document.getElementById('prevPage').addEventListener('click', () => changePage(currentPage - 1));
        document.getElementById('nextPage').addEventListener('click', () => changePage(currentPage + 1));
    }

    // ==================== FILTER FUNCTIONS ====================
    window.filterBySector = function(sector) {
        selectedSector = sector === 'all' ? 'all' : sector;

        document.querySelectorAll('.sector-chip').forEach(chip => {
            chip.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');

            const chipText = chip.textContent.trim();
            if ((sector === 'all' && chipText.includes('All Sectors')) || chipText.includes(sector)) {
                chip.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
            }
        });

        currentPage = 1;
        applyFiltersAndRender();
    }

    window.filterByMarketCap = function(capType) {
        selectedMarketCap = capType;

        document.querySelectorAll('.market-cap-chip').forEach(chip => {
            chip.classList.remove('active', 'bg-blue-600', 'text-white', 'border-blue-600');
        });

        const activeChip = document.getElementById(`marketCap${capType.charAt(0).toUpperCase() + capType.slice(1)}`);
        if (activeChip) {
            activeChip.classList.add('active', 'bg-blue-600', 'text-white', 'border-blue-600');
        }

        currentPage = 1;
        applyFiltersAndRender();
    }

    // ==================== PAGINATION ====================
    function updatePagination() {
        const totalPages = Math.ceil(displayedStocks.length / CONFIG.stocksPerPage);
        const pageNumbers = document.getElementById('pageNumbers');
        const prevButton = document.getElementById('prevPage');
        const nextButton = document.getElementById('nextPage');

        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage === totalPages || totalPages === 0;

        pageNumbers.innerHTML = '';

        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            pageButton.className = `px-3 py-1 rounded-lg ${i === currentPage ? 'pagination-btn active' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`;
            pageButton.textContent = i;
            pageButton.onclick = () => changePage(i);
            pageNumbers.appendChild(pageButton);
        }

        document.getElementById('paginationInfo').innerHTML = `
            Page <span class="text-white font-semibold">${currentPage}</span> of
            <span class="text-white font-semibold">${totalPages}</span> •
            <span class="text-gray-400">${displayedStocks.length.toLocaleString()} stocks</span>
        `;
    }

    window.changePage = function(page) {
        const totalPages = Math.ceil(displayedStocks.length / CONFIG.stocksPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderStocksTable();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };

    // ==================== ANALYZE FUNCTION ====================
    window.analyzeStock = function(symbol) {
        const stock = allStocksData.find(s => s.symbol === symbol);

        if (!stock) {
            alert('Stock data not found');
            return;
        }

        sessionStorage.setItem('analyzingStock', JSON.stringify({
            symbol: stock.symbol,
            name: stock.name,
            currentPrice: stock.price,
            change: stock.change,
            changePercent: stock.changePercent,
            marketCap: stock.marketCap,
            peRatio: (Math.random() * 30 + 5).toFixed(1),
            recommendation: stock.recommendation,
            riskLevel: {
                text: stock.riskLevel.toUpperCase(),
                class: stock.riskLevel === 'low'
                    ? 'risk-low'
                    : stock.riskLevel === 'medium'
                        ? 'risk-medium'
                        : 'risk-high'
            }
        }));

        window.location.href = 'analyze.html';
    };

    window.refreshAllData = async function() {
        console.log('🔄 Refreshing data...');
        document.getElementById('loadingProgress').textContent = 'Refreshing prices...';
        showLoadingState();

        await loadMarketIndices();
        await fetchRealPricesInBatches();
        updateLastUpdated();

        hideLoadingState();
        console.log('✅ Refresh complete');
    };

    // ==================== AUTO REFRESH ====================
    function startAutoRefresh() {
        setInterval(() => {
            if (!isLoading) {
                // Simulate small price changes
                allStocksData.forEach(stock => {
                    const priceChange = (Math.random() - 0.5) * (stock.price * 0.01);
                    stock.price = Math.max(1, stock.price + priceChange);
                    stock.change = stock.price - stock.previousClose;
                    stock.changePercent = (stock.change / stock.previousClose) * 100;
                    stock.recommendation = getRecommendation(stock.changePercent, stock.riskLevel);
                });

                if (displayedStocks.length > 0) {
                    renderStocksTable();
                }

                loadMarketIndices();
            }
        }, CONFIG.updateInterval);

        setInterval(() => {
            if (!isLoading) {
                updateLastUpdated();
            }
        }, 1000);
    }

    function updateMarketStatus() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const isMarketOpen = (hours >= 9 && hours < 15) || (hours === 15 && minutes <= 30);

        const marketStatus = isMarketOpen ? 'OPEN' : 'CLOSED';
        document.getElementById('marketStatus').textContent = marketStatus;
        document.getElementById('marketStatus').className = marketStatus === 'OPEN'
            ? 'text-lg font-bold text-green-400'
            : 'text-lg font-bold text-red-400';
    }

    function updateLastUpdated() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-IN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });

        document.getElementById('lastUpdated').innerHTML = `
            <i class="fas fa-sync-alt mr-2"></i>${timeString}
        `;
        document.getElementById('lastUpdated').classList.remove('blink');

        document.getElementById('dataFreshness').textContent = 'Just now';
    }

    // ==================== INITIALIZE FILTERS ====================
    function initializeFilters() {
        setupEventListeners();
        applyFiltersAndRender();
    }

    // ==================== AUTO REFRESH ====================
    function startAutoRefresh() {
        // Refresh market indices every 10 seconds
        setInterval(async () => {
            await loadMarketIndices();
        }, 10000);

        // Refresh real prices every 5 minutes for live stocks
        setInterval(async () => {
            if (!isLoading) {
                console.log('🔄 Auto-refreshing prices...');
                const liveStocks = allStocksData.filter(s => s.isLive);

                // Update a small batch each time
                const batch = liveStocks.slice(0, 20);
                await Promise.all(batch.map(async (stock) => {
                    try {
                        const priceData = await fetchYahooPrice(stock.symbol);
                        if (priceData && priceData.price && priceData.price > 0) {
                            stock.price = priceData.price;
                            stock.change = stock.price - stock.previousClose;
                            stock.changePercent = (stock.change / stock.previousClose) * 100;
                            stock.recommendation = getRecommendation(stock.changePercent, stock.riskLevel);
                        }
                    } catch (error) {
                        console.warn(`Failed to refresh ${stock.symbol}`);
                    }
                }));

                if (displayedStocks.length > 0) {
                    renderStocksTable();
                }
            }
        }, 300000); // 5 minutes

        // Update timestamp every second
        setInterval(() => {
            if (!isLoading) {
                updateLastUpdated();
            }
        }, 1000);
    }

    console.log('🚀 Indian Stocks Dashboard with Sector Classification initialized');
</script>
</body>
</html>